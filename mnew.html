
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IBRA Membership Form</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:system-ui,-apple-system,system-ui;
    background:#f8f9fa;
    min-height:100vh;
    padding:20px
}
.container{
    max-width:520px;
    margin:auto;
    background:#fff;
    border:1px solid #dee2e6;
    border-radius:8px;
    overflow:hidden;
    box-shadow:0 2px 10px rgba(0,0,0,.1)
}
.header{
    background:#fff;
    color:#000;
    padding:25px;
    text-align:center;
    border-bottom:1px solid #dee2e6
}
.form-section{padding:25px}
label{font-size:small;display:block;margin-top:15px;margin-bottom:5px;color:#333}
input,textarea{
    width:100%;
    padding:12px;
    border:2px solid #dee2e6;
    border-radius:6px;
    font-size:15px;
    background:#fff;
    color:#000
}
textarea{resize:vertical}
.date-group{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.error{color:#dc3545;font-size:14px;display:none}
.success{color:#28a745;font-size:14px;display:block}
.signature-pad{
    height:150px;
    border:2px solid #ccc;
    border-radius:6px;
    background:#fff;
    position:relative
}
.signature-pad canvas{
    width:100%;
    height:100%;
    background:#fff;
    border-radius:4px
}
.btn{
    padding:12px 20px;
    border:1px solid #dee2e6;
    border-radius:6px;
    cursor:pointer;
    margin:5px 10px 5px 0;
    background:#fff;
    color:#000;
    font-weight:500
}
.btn-submit{
    width:100%;
    margin-top:25px;
    font-size:18px;
    background:#007bff;
    color:#fff;
    border-color:#007bff
}
.btn-whatsapp{
    background:#25D366;
    color:#fff;
    border-color:#25D366;
    width:100%;
    margin-top:10px
}
.btn:hover{background:#0056b3;border-color:#0056b3}
.btn-whatsapp:hover{background:#128C7E;border-color:#128C7E}
@media(max-width:480px){
    .date-group{grid-template-columns:1fr}
    .btn{margin:5px 0}
}
.dob {background:#fff3cd; padding:0 5px}
#dob {background:#fff3cd;}
.doj {background:#d1ecf1; padding:0 5px}
#doj {background:#d1ecf1;}
.dor {background:#d4edda; padding:0 5px}
#dor {background:#d4edda;}
</style>
</head>

<body>

<div class="container">
<div class="header">
<h2 style="margin:0;font-size:24px;color:#000">IBRA Membership Form</h2>
</div>

<form id="pensionForm" class="form-section">

<label>Name *</label>
<input id="pensionerName" required>

<label>SR No / Employee ID * <span class="error" id="empIdError"></span></label>
<input id="empId" type="number" min="1" required inputmode="numeric">

<label>Dates of <span class='dob'>Birth</span>, <span class='doj'>Joining</span>, <span class='dor'>Retirement*</span></label>
<div class="date-group">
<input type="date" id="dob" required inputmode="numeric">
<input type="date" id="doj" required inputmode="numeric">
<input type="date" id="dor" required inputmode="numeric">
</div>
<div class="error" id="dateError"></div>
<div class="success" id="dateSuccess">‚úì DOB ‚Üí DOJ(18-30yrs) DOR(50-60yrs, last day)</div>

<label>Address with District, State and PIN Code *</label>
<textarea id="address" required></textarea>

<label>Mobile 1 * <span class="error" id="mobile1Error"></span></label>
<input id="mobile1" type="tel" required inputmode="numeric" maxlength="10">

<label>Mobile 2 <span class="error" id="mobile2Error"></span></label>
<input id="mobile2" type="tel" inputmode="numeric" maxlength="10">

<label>Email *</label>
<input type="email" id="email" required>

<label>Pension Branch *</label>
<input id="branch" required>

<label>Spouse Name</label>
<input id="spouse">

<label>Signature *</label>
<div class="signature-pad">
<canvas id="signatureCanvas"></canvas>
</div>
<button type="button" class="btn" onclick="clearSignature()">Clear Signature</button>
<div class="error" id="signatureError">Signature required</div>

<button type="button" class="btn btn-whatsapp" onclick="sendToWhatsApp()">
üì± Send to WhatsApp
</button>

<button type="submit" class="btn btn-submit">üíæ Generate PDF</button>
</form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>

<script>
// =============================
// SHORTCUT
// =============================
const $ = id => document.getElementById(id);

// =============================
// SAFE DATE HELPERS (NO TZ BUG)
// =============================
function parseInputDate(value) {
    const [y, m, d] = value.split("-").map(Number);
    return new Date(y, m - 1, d); // local date (safe)
}

function formatDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
}

function addYears(date, years) {
    return new Date(
        date.getFullYear() + years,
        date.getMonth(),
        date.getDate()
    );
}

// =============================
// ELEMENTS
// =============================
const dob = $("dob"), doj = $("doj"), dor = $("dor");
const dateError = $("dateError"), dateSuccess = $("dateSuccess");
const mobile1Error = $("mobile1Error"), mobile2Error = $("mobile2Error");
const signatureError = $("signatureError");
const form = $("pensionForm");

// =============================
// DOR MAX RULE (BUSINESS RULE)
// =============================
function getMaxDOR(birthDate) {
    const sixty = addYears(birthDate, 60);

    if (birthDate.getDate() === 1) {
        return new Date(sixty.getFullYear(), sixty.getMonth(), 0);
    } else {
        return new Date(sixty.getFullYear(), sixty.getMonth() + 1, 0);
    }
}

// =============================
// AUTO DATE CALCULATION
// =============================
function autoDates() {
    if (!dob.value) return;

    const b = parseInputDate(dob.value);

    doj.value = formatDate(addYears(b, 24));

    const maxDor = getMaxDOR(b);
    dor.value = formatDate(maxDor);

    validateDates();
}

// =============================
// DATE VALIDATION
// =============================
function validateDates() {
    if (!dob.value || !doj.value || !dor.value) return false;

    const b = parseInputDate(dob.value);
    const j = parseInputDate(doj.value);
    const r = parseInputDate(dor.value);

    const minDOJ = addYears(b, 18);
    const maxDOJ = addYears(b, 30);

    const minDOR = addYears(b, 50);
    const maxDOR = getMaxDOR(b);

    let error = "";

    if (j < minDOJ || j > maxDOJ)
        error = "‚ùå DOJ must be between 18‚Äì30 years from DOB (exact).";

    else if (r < minDOR || r > maxDOR)
        error = `‚ùå DOR must be between 50 years and ${formatDate(maxDOR)}.`;

    else if (!(b < j && j < r))
        error = "‚ùå Must follow DOB < DOJ < DOR.";

    if (error) {
        dateError.textContent = error;
        dateError.style.display = "block";
        dateSuccess.style.display = "none";
        return false;
    }

    dateError.style.display = "none";
    dateSuccess.style.display = "block";
    dateSuccess.textContent = "‚úì Dates validated";
    return true;
}

// =============================
// MOBILE VALIDATION
// =============================
function validateMobile(input, errorEl) {
    const v = input.value.replace(/\D/g, "");
    const ok = !v || /^[6-9]\d{9}$/.test(v);
    errorEl.style.display = ok ? "none" : "block";
    if (!ok) errorEl.textContent = "10 digits, starts with 6-9";
    return ok;
}

// =============================
// SIGNATURE PAD
// =============================
const canvas = $("signatureCanvas");
const ctx = canvas.getContext("2d");
canvas.width = 400;
canvas.height = 150;

ctx.fillStyle = "#fff";
ctx.fillRect(0, 0, canvas.width, canvas.height);

let drawing = false, hasSignature = false;

function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return { x: t.clientX - rect.left, y: t.clientY - rect.top };
}

["mousedown","touchstart"].forEach(ev =>
    canvas.addEventListener(ev, e => {
        e.preventDefault();
        drawing = true;
        hasSignature = true;
        const {x,y} = getPos(e);
        ctx.beginPath();
        ctx.moveTo(x,y);
    })
);

["mousemove","touchmove"].forEach(ev =>
    canvas.addEventListener(ev, e => {
        if (!drawing) return;
        e.preventDefault();
        const {x,y} = getPos(e);
        ctx.lineTo(x,y);
        ctx.stroke();
    })
);

["mouseup","mouseout","touchend"].forEach(ev =>
    canvas.addEventListener(ev, () => drawing = false)
);

function clearSignature(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    hasSignature=false;
    signatureError.style.display="none";
}

// =============================
// FORM DATA
// =============================
function getData(){
    return {
        name: $("pensionerName").value.trim(),
        empId: $("empId").value.trim(),
        dob: dob.value,
        doj: doj.value,
        dor: dor.value,
        address: $("address").value.trim(),
        mobile1: $("mobile1").value.trim(),
        mobile2: $("mobile2").value.trim(),
        email: $("email").value.trim(),
        branch: $("branch").value.trim(),
        spouse: $("spouse").value.trim()
    };
}

function requiredFilled(d){
    return d.name && d.empId && d.address &&
           d.mobile1 && d.email && d.branch;
}

// =============================
// WHATSAPP
// =============================
function sendToWhatsApp(){
    const d = getData();

    if (!requiredFilled(d) || !validateDates() ||
        !validateMobile($("mobile1"), mobile1Error) ||
        !hasSignature)
        return alert("Please complete form correctly.");

    const msg =
`IBRA Membership Form

Name: ${d.name}
Employee ID: ${d.empId}
DOB: ${d.dob}
DOJ: ${d.doj}
DOR: ${d.dor}

Address:
${d.address}

Mobile 1: ${d.mobile1}
${d.mobile2 ? `Mobile 2: ${d.mobile2}\n` : ""}Email: ${d.email}
Branch: ${d.branch}
${d.spouse ? `Spouse: ${d.spouse}\n` : ""}
Generated: ${new Date().toLocaleString("en-IN")}`;

    window.open(`https://wa.me/919989036183?text=${encodeURIComponent(msg)}`, "_blank");
}

// =============================
// PDF GENERATION (WITH CERTIFICATE)
// =============================
form.addEventListener("submit", e => {
    e.preventDefault();

    const d = getData();

    if (!requiredFilled(d) || !validateDates() || !hasSignature)
        return alert("Please complete form correctly.");

    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text("IBRA MEMBERSHIP FORM",105,20,{align:"center"});

    let y = 35;

    // CERTIFICATE
    doc.setFontSize(11);
    const cert =
`I hereby certify that the information furnished above is true and correct to the best of my knowledge and belief. I understand that any false or incorrect information may result in rejection or cancellation of membership at any stage.`;

    const certLines = doc.splitTextToSize(cert,170);
    doc.text(certLines,20,y);
    y += certLines.length * 6 + 10;

    doc.setFontSize(12);

    const fields = [
        ["Name", d.name],
        ["Employee ID", d.empId],
        ["Date of Birth", d.dob],
        ["Date of Joining", d.doj],
        ["Date of Retirement", d.dor]
    ];

    fields.forEach(([label,value])=>{
        doc.text(`${label}: ${value}`,20,y);
        y+=8;
    });

    // ADDRESS FIX (NO OVERWRITE)
    doc.text("Address:",20,y);
    y+=8;

    doc.setFontSize(10);
    const addrLines = doc.splitTextToSize(d.address,170);
    doc.text(addrLines,20,y);
    y += addrLines.length * 6 + 6;

    doc.setFontSize(12);

    doc.text(`Mobile 1: ${d.mobile1}`,20,y); y+=8;
    if(d.mobile2){ doc.text(`Mobile 2: ${d.mobile2}`,20,y); y+=8; }
    doc.text(`Email: ${d.email}`,20,y); y+=8;
    doc.text(`Branch: ${d.branch}`,20,y); y+=8;
    if(d.spouse){ doc.text(`Spouse: ${d.spouse}`,20,y); y+=8; }

    y+=10;
    doc.text("Signature:",20,y);
    doc.addImage(canvas.toDataURL(),"PNG",20,y+5,120,35);

    doc.setFontSize(9);
    doc.text(`Generated on: ${new Date().toLocaleString("en-IN")}`,20,285);

    doc.save(`IBRA_${d.empId}.pdf`);
});

// =============================
// INIT
// =============================
document.addEventListener("DOMContentLoaded",()=>{
    const today=new Date();
    dob.value=formatDate(
        new Date(today.getFullYear()-60,today.getMonth(),today.getDate())
    );

    autoDates();

    dob.addEventListener("change",autoDates);
    doj.addEventListener("change",validateDates);
    dor.addEventListener("change",validateDates);

    $("mobile1").addEventListener("input",e=>validateMobile(e.target,mobile1Error));
    $("mobile2").addEventListener("input",e=>validateMobile(e.target,mobile2Error));
});
</script>

</body>
</html>
