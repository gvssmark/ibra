<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IBRA Membership Form</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:system-ui,-apple-system,system-ui;
    background:#f8f9fa;
    min-height:100vh;
    padding:20px
}
.container{
    max-width:520px;
    margin:auto;
    background:#fff;
    border:1px solid #dee2e6;
    border-radius:8px;
    overflow:hidden;
    box-shadow:0 2px 10px rgba(0,0,0,.1)
}
.header{
    background:#fff;
    color:#000;
    padding:25px;
    text-align:center;
    border-bottom:1px solid #dee2e6
}
.form-section{padding:25px}
label{font-size:small;display:block;margin-top:15px;margin-bottom:5px;color:#333}
input,textarea{
    width:100%;
    padding:12px;
    border:2px solid #dee2e6;
    border-radius:6px;
    font-size:15px;
    background:#fff;
    color:#000
}
textarea{resize:vertical}
.date-group{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.error{color:#dc3545;font-size:14px;display:none}
.success{color:#28a745;font-size:14px;display:block}
.signature-pad{
    height:150px;
    border:2px solid #ccc;
    border-radius:6px;
    background:#fff;
    position:relative
}
.signature-pad canvas{
    width:100%;
    height:100%;
    background:#fff;
    border-radius:4px
}
.btn{
    padding:12px 20px;
    border:1px solid #dee2e6;
    border-radius:6px;
    cursor:pointer;
    margin:5px 10px 5px 0;
    background:#fff;
    color:#000;
    font-weight:500
}
.btn-submit{
    width:100%;
    margin-top:25px;
    font-size:18px;
    background:#007bff;
    color:#fff;
    border-color:#007bff
}
.btn-whatsapp{
    background:#25D366;
    color:#fff;
    border-color:#25D366;
    width:100%;
    margin-top:10px
}
.btn:hover{background:#0056b3;border-color:#0056b3}
.btn-whatsapp:hover{background:#128C7E;border-color:#128C7E}
@media(max-width:480px){
    .date-group{grid-template-columns:1fr}
    .btn{margin:5px 0}
}
.dob {background:#fff3cd; padding:0 5px}
#dob {background:#fff3cd;}
.doj {background:#d1ecf1; padding:0 5px}
#doj {background:#d1ecf1;}
.dor {background:#d4edda; padding:0 5px}
#dor {background:#d4edda;}
</style>
</head>

<body>

<div class="container">
<div class="header">
<h2 style="margin:0;font-size:24px;color:#000">IBRA Membership Form</h2>
</div>

<form id="pensionForm" class="form-section">

<label>Name *</label>
<input id="pensionerName" required>

<label>SR No / Employee ID * <span class="error" id="empIdError"></span></label>
<input id="empId" type="number" min="1" required inputmode="numeric">

<label>Dates of <span class='dob'>Birth</span>, <span class='doj'>Joining</span>, <span class='dor'>Retirement*</span></label>
<div class="date-group">
<input type="date" id="dob" required inputmode="numeric">
<input type="date" id="doj" required inputmode="numeric">
<input type="date" id="dor" required inputmode="numeric">
</div>
<div class="error" id="dateError"></div>
<div class="success" id="dateSuccess">‚úì DOB ‚Üí DOJ(18-30yrs) DOR(50-60yrs, last day)</div>

<label>Address with District, State and PIN Code *</label>
<textarea id="address" required></textarea>

<label>Mobile 1 * <span class="error" id="mobile1Error"></span></label>
<input id="mobile1" type="tel" required inputmode="numeric" maxlength="10">

<label>Mobile 2 <span class="error" id="mobile2Error"></span></label>
<input id="mobile2" type="tel" inputmode="numeric" maxlength="10">

<label>Email *</label>
<input type="email" id="email" required>

<label>Pension Branch *</label>
<input id="branch" required>

<label>Spouse Name</label>
<input id="spouse">

<label>Signature *</label>
<div class="signature-pad">
<canvas id="signatureCanvas"></canvas>
</div>
<button type="button" class="btn" onclick="clearSignature()">Clear Signature</button>
<div class="error" id="signatureError">Signature required</div>

<button type="button" class="btn btn-whatsapp" onclick="sendToWhatsApp()">
üì± Send to WhatsApp
</button>

<button type="submit" class="btn btn-submit">üíæ Generate PDF</button>
</form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>

<script>
// ‚úÖ WHATSAPP NOW FULLY VALIDATES DATES - FIXED!
const dob = document.getElementById("dob");
const doj = document.getElementById("doj");
const dor = document.getElementById("dor");
const dateError = document.getElementById("dateError");
const dateSuccess = document.getElementById("dateSuccess");
const signatureError = document.getElementById("signatureError");
const empIdError = document.getElementById("empIdError");
const mobile1Error = document.getElementById("mobile1Error");
const mobile2Error = document.getElementById("mobile2Error");

let signatureCanvas = document.getElementById("signatureCanvas");
let ctx = signatureCanvas.getContext("2d");
signatureCanvas.width = 400;
signatureCanvas.height = 150;
let hasSignature = false;
let isDrawing = false;

function addYears(date, years) {
    const newDate = new Date(date);
    newDate.setFullYear(date.getFullYear() + years);
    return newDate;
}

function getLastDayOfDOBMonth(dobDate, yearsOffset) {
    const futureDate = addYears(dobDate, yearsOffset);
    const lastDay = new Date(futureDate.getFullYear(), futureDate.getMonth() + 1, 0);
    return lastDay;
}

function getLastDayPrevMonth(dobDate) {
    const fiftyYearsLater = addYears(dobDate, 50);
    const prevMonthLastDay = new Date(fiftyYearsLater.getFullYear(), fiftyYearsLater.getMonth(), 0);
    return prevMonthLastDay;
}

function updateDependentDates() {
    if (dob.value) {
        const dobDate = new Date(dob.value + 'T00:00:00');
        
        const dojDate = addYears(dobDate, 24);
        doj.value = dojDate.toISOString().split('T')[0];
        
        let dorDate;
        if (dobDate.getDate() === 1) {
            dorDate = getLastDayPrevMonth(dobDate);
        } else {
            dorDate = getLastDayOfDOBMonth(dobDate, 55);
        }
        dor.value = dorDate.toISOString().split('T')[0];
    }
    validateDates();
}

function validateDates() {
    if (dob.value && doj.value && dor.value) {
        const dobDate = new Date(dob.value + 'T00:00:00');
        const dojDate = new Date(doj.value + 'T00:00:00');
        const dorDate = new Date(dor.value + 'T00:00:00');
        
        const yearsDOJ = dojDate.getFullYear() - dobDate.getFullYear();
        const yearsDOR = dorDate.getFullYear() - dobDate.getFullYear();
        
        if (yearsDOJ < 18 || yearsDOJ > 30) {
            dateError.textContent = `‚ùå DOJ must be 18-30 years from DOB (${yearsDOJ} years)`;
            dateError.style.display = "block";
            dateSuccess.style.display = "none";
            return false;
        }
        
        if (yearsDOR < 50 || yearsDOR > 60) {
            dateError.textContent = `‚ùå DOR must be 50-60 years from DOB (${yearsDOR} years)`;
            dateError.style.display = "block";
            dateSuccess.style.display = "none";
            return false;
        }
        
        if (dobDate >= dojDate || dojDate >= dorDate) {
            dateError.textContent = "‚ùå DOB < DOJ < DOR required";
            dateError.style.display = "block";
            dateSuccess.style.display = "none";
            return false;
        }
        
        dateError.style.display = "none";
        dateSuccess.style.display = "block";
        dateSuccess.textContent = `‚úì DOJ(${yearsDOJ}yrs) DOR(${yearsDOR}yrs) - Validated`;
        return true;
    }
    return false; // Fail if dates missing
}

function validateMobile(input, errorEl) {
    const value = input.value.replace(/\D/g, '');
    if (value) {
        if (value.length !== 10 || !/^[6-9]\d{9}$/.test(value)) {
            errorEl.textContent = "10 digits, starts with 6-9";
            errorEl.style.display = "block";
            input.style.borderColor = "#dc3545";
            return false;
        }
    }
    errorEl.style.display = "none";
    input.style.borderColor = "#dee2e6";
    return true;
}

document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const currentYear = today.getFullYear();
    const dobDate = new Date(currentYear - 60, today.getMonth(), today.getDate());
    dob.value = dobDate.toISOString().split('T')[0];
    updateDependentDates();
    
    dob.addEventListener("change", updateDependentDates);
    doj.addEventListener("change", validateDates);
    dor.addEventListener("change", validateDates);
    
    document.getElementById("empId").addEventListener("input", function() {
        const value = this.value;
        if (value && (!/^\d+$/.test(value) || value.length > 10)) {
            empIdError.textContent = "Enter valid number (max 10 digits)";
            empIdError.style.display = "block";
            this.style.borderColor = "#dc3545";
        } else {
            empIdError.style.display = "none";
            this.style.borderColor = "#dee2e6";
        }
    });
    
    document.getElementById("mobile1").addEventListener("input", function() {
        validateMobile(this, mobile1Error);
    });
    document.getElementById("mobile2").addEventListener("input", function() {
        validateMobile(this, mobile2Error);
    });
});

// Signature events
signatureCanvas.addEventListener("mousedown", function(e) {
    isDrawing = true;
    hasSignature = true;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx.beginPath();
    ctx.moveTo(x, y);
});

signatureCanvas.addEventListener("mousemove", function(e) {
    if (isDrawing) {
        const rect = signatureCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        ctx.lineTo(x, y);
        ctx.stroke();
    }
});

signatureCanvas.addEventListener("mouseup", function() { isDrawing = false; });
signatureCanvas.addEventListener("mouseout", function() { isDrawing = false; });

signatureCanvas.addEventListener("touchstart", function(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent("mousedown", {clientX: touch.clientX, clientY: touch.clientY});
    signatureCanvas.dispatchEvent(mouseEvent);
});
signatureCanvas.addEventListener("touchmove", function(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent("mousemove", {clientX: touch.clientX, clientY: touch.clientY});
    signatureCanvas.dispatchEvent(mouseEvent);
});
signatureCanvas.addEventListener("touchend", function(e) {
    e.preventDefault();
    const mouseEvent = new MouseEvent("mouseup", {});
    signatureCanvas.dispatchEvent(mouseEvent);
});

function clearSignature() {
    ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    hasSignature = false;
    signatureError.style.display = "none";
}

// ‚úÖ FIXED - FULL VALIDATION BEFORE WHATSAPP
function sendToWhatsApp() {
    // Get form data
    const formData = {
        name: document.getElementById("pensionerName").value.trim(),
        empId: document.getElementById("empId").value.trim(),
        dob: dob.value,
        doj: doj.value,
        dor: dor.value,
        address: document.getElementById("address").value.trim(),
        mobile1: document.getElementById("mobile1").value.trim(),
        mobile2: document.getElementById("mobile2").value.trim(),
        email: document.getElementById("email").value.trim(),
        branch: document.getElementById("branch").value.trim(),
        spouse: document.getElementById("spouse").value.trim()
    };
    
    // ‚úÖ CRITICAL DATE VALIDATION FIRST
    if (!validateDates()) {
        alert("‚ùå Date validation failed! Please check DOB, DOJ, DOR.");
        dateError.style.display = "block";
        return;
    }
    
    // Check all required fields
    if (!formData.name || !formData.empId || !formData.address || 
        !formData.mobile1 || !formData.email || !formData.branch) {
        alert("Please fill all required fields (* marked)");
        return;
    }
    
    // Mobile 1 validation
    if (!validateMobile(document.getElementById("mobile1"), mobile1Error)) {
        alert("Please enter valid Mobile 1 number");
        return;
    }
    
    // Signature check
    if (!hasSignature) {
        alert("Please provide signature");
        signatureError.style.display = "block";
        return;
    }
    
    // ‚úÖ ALL VALID - SEND WHATSAPP
    const message = `*üÜî IBRA Membership Form*\n\n` +
        `*üë§ Name:* ${formData.name}\n` +
        `*üÜî SR No/Employee ID:* ${formData.empId}\n` +
        `*üìÖ DOB:* ${formData.dob}\n` +
        `*üìÖ DOJ:* ${formData.doj}\n` +
        `*üìÖ DOR:* ${formData.dor}\n\n` +
        `*üìç Address:*\n${formData.address}\n\n` +
        `*üì± Mobile 1:* ${formData.mobile1}\n` +
        `${formData.mobile2 ? `*üì± Mobile 2:* ${formData.mobile2}\n` : ''}` +
        `*üìß Email:* ${formData.email}\n` +
        `*üè¶ Pension Branch:* ${formData.branch}\n` +
        `${formData.spouse ? `*üë´ Spouse:* ${formData.spouse}\n` : ''}` +
        `*üìù Generated:* ${new Date().toLocaleString('en-IN')}`;
    
    const whatsappNumber = "919989036183"; // UPDATE YOUR NUMBER
    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
    
    //alert("‚úÖ WhatsApp message prepared with validated data!");
}

// PDF submission (already validates)
document.getElementById("pensionForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const formData = {
        name: document.getElementById("pensionerName").value.trim(),
        empId: document.getElementById("empId").value.trim(),
        dob: dob.value,
        doj: doj.value,
        dor: dor.value,
        address: document.getElementById("address").value.trim(),
        mobile1: document.getElementById("mobile1").value.trim(),
        mobile2: document.getElementById("mobile2").value.trim(),
        email: document.getElementById("email").value.trim(),
        branch: document.getElementById("branch").value.trim(),
        spouse: document.getElementById("spouse").value.trim()
    };
    
    if (!formData.name || !formData.empId || !formData.address || 
        !formData.mobile1 || !formData.email || !formData.branch ||
        !validateDates() || !hasSignature) {
        alert("Please fill all required fields and signature");
        return;
    }
    
    generatePDF(formData, signatureCanvas.toDataURL());
});

function generatePDF(formData, signatureData) {
    const doc = new jsPDF();
    doc.setFontSize(20);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(0, 0, 0);
    doc.text("IBRA MEMBERSHIP FORM", 105, 25, { align: "center" });
    
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(0, 0, 0);
    
    let yPos = 45;
    doc.text(`Name: ${formData.name}`, 20, yPos); yPos += 8;
    doc.text(`SR No/Employee ID: ${formData.empId}`, 20, yPos); yPos += 8;
    doc.text(`Date of Birth: ${formData.dob}`, 20, yPos); yPos += 8;
    doc.text(`Date of Joining: ${formData.doj}`, 20, yPos); yPos += 8;
    doc.text(`Date of Retirement: ${formData.dor}`, 20, yPos); yPos += 12;
    
    doc.text("Address:", 20, yPos);
    doc.setFontSize(10);
    const addressLines = doc.splitTextToSize(formData.address, 170);
    doc.text(addressLines, 30, yPos + 8);
    yPos += 25 + (addressLines.length - 1) * 5;
    doc.setFontSize(12);
    
    doc.text(`Mobile 1: ${formData.mobile1}`, 20, yPos); yPos += 8;
    if (formData.mobile2) { doc.text(`Mobile 2: ${formData.mobile2}`, 20, yPos); yPos += 8; }
    doc.text(`Email: ${formData.email}`, 20, yPos); yPos += 8;
    doc.text(`Pension Branch: ${formData.branch}`, 20, yPos); yPos += 12;
    
    if (formData.spouse) { doc.text(`Spouse Name: ${formData.spouse}`, 20, yPos); yPos += 12; }
    
    doc.text("Signature:", 20, yPos);
    doc.addImage(signatureData, 'PNG', 20, yPos + 5, 160, 40);
    
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 20, 285);
    
    doc.save(`IBRA_Membership_${formData.empId}_${formData.name.replace(/\s+/g, '_')}.pdf`);
    alert("‚úÖ PDF Generated Successfully!");
}

ctx.fillStyle = "#fff";
ctx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
</script>

</body>
</html>
