<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,maximum-scale=1,initial-scale=1.0">
  <title>IBRA Members</title>
  <style>
    body{background:wheat;font-size:small;margin:0 auto;box-sizing:border-box;width:100%;max-width:500px}
    h2{position:fixed;top:0;width:100%;max-width:480px;background:#004080;color:#fff;text-align:center;padding:10px;margin:0;z-index:1000}
    #regions{margin-top:60px}
    #DataLoadedFrom{text-align:center;margin-top:141px}
    .pname{font-family:Poppins,sans-serif;text-shadow:3px 3px 3px #ababab;font-size:25px}
    a{text-decoration:none}
    .active,.btn:hover{background:red;color:#fff}
    #regionTable td:hover{background:#9999997d;color:#fff}
    ul{list-style-type:none;margin:0;padding:0;overflow:hidden;background:#333;padding-bottom:5px; }
    li{float:left;font-size:small}
    .list{display:block;color:#fff;text-align:center;padding:2px 6px}
    table{border-collapse:collapse;width:100%;border:1px solid #000;font-size:small}
    #myInput{width:90%;margin:5px auto;display:block;height:30px;border-radius:15px;background:cyan;border:0;outline:0}
    .modal{display:none;position:fixed;z-index:2;padding-top:1px;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.4)}
    .modal-content{background:#99ffcc;margin:auto;padding:5px;border:1px solid #888;width:95%;border-radius:15px;margin-top:153px}
    .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
    .close:hover{color:#000}
    .badge,.badge1,.eabbadge,.smallbadge,.smalleabbadge{display:inline-block;text-align:center;vertical-align:baseline;border-radius:50px}
    .badge{width:25px;height:25px;line-height:25px;font-size:x-small;color:#fff;background:#d73d33}
    .badge1{width:25px;height:25px;line-height:25px;font-size:small;color:#000;background:yellow}
    .eabbadge{width:25px;height:25px;line-height:25px;font-size:small;color:#000;background:pink}
    .smallbadge{width:10px;height:10px;line-height:10px;color:green;background:yellow}
    .smalleabbadge{width:10px;height:10px;line-height:10px;color:green;background:pink}
    button{background:yellow;border:0;width:170px;padding:5px;border-radius:15px;box-shadow:3px 5px #888;margin-left:5px}
    img{border-radius:50px}
    #topBtn{display:none;position:fixed;bottom:20px;right:20px;z-index:99;background:#004080;color:#fff;border:none;outline:none;width:45px;height:45px;border-radius:50%;cursor:pointer;font-size:18px}
    
    #paraInThisRegion {}
  </style>
</head>
<body>
<h2>Indian Bank Retirees Association</h2>
<div id="regions">
  <div style="background:powderblue;top:43px;position:fixed;width:100%;max-width:500px;z-index:999">
    <ul >
      <li onclick="selectedRegion('allmemb',0)" class="list active">All</li>
      <li onclick="selectedRegion('VSP',1)" class="list">VSP</li>
      <li onclick="selectedRegion('GOD',2)" class="list">GOD</li>
      <li onclick="selectedRegion('VIJ',3)" class="list">VIJ</li>
      <li onclick="selectedRegion('SEE',4)" class="list">SEEMA</li>
      <li onclick="selectedRegion('HYD',5)" class="list">HYD</li>
      <li onclick="selectedRegion('OTH',6)" class="list">OTH</li>
      <li onclick="selectedRegion('EAB',7)" class="list">eAB</li>
      <li onclick="selectedRegion('allMembNoWise',8)" class="list">SR No</li>
    </ul>
    <h4 id='regionHeading' align="center" style="margin:0"></h4>
    <input type="text" id='myInput' placeholder="Search here..." onkeyup="fiterName()">
  </div>
  <p id='DataLoadedFrom'>Loading...</p>  
  <p id='paraInThisRegion'></p>
  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h4 align="center" id="nameHeader"></h4>
      <p id="modalData"></p>
      <div id='photo' style='margin-top:-266px;float:right'></div>
      <div id='whatsapp'></div>
    </div>
  </div>
</div>
<button onclick="scrollToTop()" id="topBtn">â†‘</button>

<script>

 window.onscroll=function(){document.getElementById("topBtn").style.display=document.documentElement.scrollTop>200?"block":"none";}
  function scrollToTop(){document.documentElement.scrollTop=0;}
  
  //==== Utility: Date Formatting ====
function formatDate(input) {
  const date = new Date(input);
  return isNaN(date) ? 'Not Available' : date.toLocaleString('en-GB');
}

//==== Fetch Data Functions ====
async function fetchJson(url) {
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`Fetch failed: ${url}`);
  return await res.json();
}
async function fetchLatestTimestamp() {
  const url = 'https://script.google.com/macros/s/AKfycbwo-TtPn3DAjHSPCXDwPFerT36QyfPPvUTi7uQEvcmjJso_aWpaKefUsgx_vpJOowHUgg/exec?sheetid=1MaB1PMP3ouY3Es5ziLgY7dhT3ZSb6oHRgecw3JiJfGw&sheetname=Sheet1';
  const res = await fetch(url, { cache: 'no-store' });
  const text = (await res.text()).trim();
  // Handle [[timestamp]] case
  try {
    const parsed = JSON.parse(text);
    return Array.isArray(parsed) ? parsed.flat(Infinity)[0] : parsed;
  } catch {
    return text;
  }
}
async function cacheData(key, data) {
  const cache = await caches.open('addbook');
  const response = new Response(JSON.stringify(data), { headers: { 'Content-Type': 'application/json' } });
  await cache.put(key, response);
}
async function readCachedData(key) {
  const cache = await caches.open('addbook');
  const response = await cache.match(key);
  if (!response || !response.ok) return null;
  try {
    return await response.json();
  } catch {
    return null;
  }
}
async function fetchAddBookData() {
  const url = 'https://script.google.com/macros/s/AKfycbwIVAlRrCTt6z_Ej4W6PHhopFqCq1JvEsSoN2RPqgWY7VXLW0P2pteA1jgVFaWePc2S/exec';
  let data = await fetchJson(url);
  data.shift(); // remove header
  const formatted = data.map(([id, name, add1, add2, add3, district, place, pincode, fixed, mobile1, mobile2, state, email, srno, sbac, doj, dor, spname, area, blank1, dob, fampen, pensionbr, scanned, newempid, dod, blank2, blank3, blank4]) => ({
    id, name, add1, add2, add3, district, place, pincode, fixed, mobile1, mobile2, state, email, srno, sbac,
    doj: formatDate(doj), dor: formatDate(dor), spname, area, blank1, dob: formatDate(dob), fampen, pensionbr, scanned, newempid, dod: formatDate(dod),
    blank2, blank3, blank4
  }));
  await cacheData('/custom/addbookdata.json', formatted);
  return formatted;
}
async function fetchPhotoData() {
  const url = 'https://script.google.com/macros/s/AKfycbw_h5LMGCyIraesAhh6xlkeP8RUz3HO4ga4Q8XZaJhJRpnuQqp3TWUUZyodZPxpeA7A/exec';
  let data = await fetchJson(url);
  data.shift();
  const photos = data.map(([id, photoid]) => ({ id, photoid }));
  await cacheData('/custom/addbookphotodata.json', photos);
  return photos;
}

//==== Report Renderer ====
function showReport(addBookData, photoData, source, serverTimestamp) {
  document.getElementById("DataLoadedFrom").textContent =
    `Report from: ${source} - ${formatDate(serverTimestamp-(5.5*60*60*1000))}`;
  //document.getElementById("Addressbookdata").textContent =
    "Addressbook Records: " + (addBookData ? addBookData.length : 0);
  //document.getElementById("Photodata").textContent =
    "Photo Records: " + (photoData ? photoData.length : 0);
  //document.getElementById("DataLastUpdatedOn").textContent =
    "Data Last Updated on: " + formatDate(serverTimestamp-(5.5*60*60*1000));
    data = addBookData
    photodata = photoData
    isPhoto = (id) => photodata.some(a => a.id.toString() === id.toString()) ? '<span>ðŸ‘¨</span>' : '';
    processData()
    console.log(activeMembers)
    console.log(photodata)
    selectedRegion('allmemb', 0);
}

//==== Init with Cache-then-Network Strategy ====
async function initReport() {
  // 1. Try cache first (instant report)
  let [addBookData, photoData] = await Promise.all([
    readCachedData('/custom/addbookdata.json'),
    readCachedData('/custom/addbookphotodata.json')
  ]);

  const localTimestamp = localStorage.getItem("data_updated_at");

  if (addBookData && photoData && localTimestamp) {
    showReport(addBookData, photoData, "Cache", localTimestamp);
  } else {
    document.getElementById("DataLoadedFrom").textContent = "No cache, waiting for server...";
  }

  // 2. In background, check server timestamp
  try {
    const serverTimestamp = await fetchLatestTimestamp();
    const localTimestamp = localStorage.getItem("data_updated_at");

    if (!addBookData || !photoData || localTimestamp != serverTimestamp) {
      // Fetch fresh if missing or outdated
      [addBookData, photoData] = await Promise.all([
        fetchAddBookData(),
        fetchPhotoData()
      ]);
      localStorage.setItem("data_updated_at", serverTimestamp);
      showReport(addBookData, photoData, "Server (updated)", serverTimestamp);
    }
  } catch (err) {
    console.error("Background refresh failed", err);
  }
}

initReport();

function processData() {
  activeMembers = data.filter(a => a.name !== "").sort((a, b) => a.name.localeCompare(b.name));
  activeMembers.forEach(element => {
    element.IBorEAB = (element.area.substr(-3).toUpperCase() === 'EAB' ? "EAB" : "IB");
    element.pentype = (element.fampen.length > 0 ? "fam" : "ser");
  });
  familyPensioners = activeMembers.filter(a => a.fampen !== "")
    .map(a => ({ id: a.id, name: a.name, fampen: a.fampen, ibeab: a.IBorEAB }));
  blank = activeMembers.filter(a => a.area === "BLANK")
    .map(a => ({ id: a.id, name: a.name, fampen: a.fampen, ibeab: a.IBorEAB, srno: a.srno, mobile: a.mobile1 }));
  allMembNoWise = activeMembers.map(a => ({
    id: a.id, name: a.name, fampen: a.fampen, ibeab: a.IBorEAB,
    srno: a.srno, mobile: a.mobile1, newempid: a.newempid
  })).sort((a, b) => a.srno - b.srno);
  allmemb = activeMembers.map(a => ({
    id: a.id, name: a.name, fampen: a.fampen, ibeab: a.IBorEAB,
    srno: a.srno, mobile: a.mobile1, newempid: a.newempid
  }));
   
}

function selectedRegion(array, n) {
                let tany = activeMembers.filter(a => a.area.includes(array)).map(a => ({
                    id: a.id, name: a.name, fampen: a.fampen, ibeab: a.IBorEAB,
                    srno: a.srno, mobile: a.mobile1, newempid: a.newempid
                }));
                let tarr = array === 'allmemb' ? allmemb : array === 'allMembNoWise' ? allMembNoWise : tany;
                document.getElementById("myInput").value = "";
                document.getElementById("myInput").style.display = "block";
                document.documentElement.scrollTop = 0;

                let famPensionersCount = tarr.filter(a => a.fampen.length > 0).length;
                let eabcount = tarr.filter(a => a.ibeab === 'EAB').length;
                let regions = ["All Members", "Visakhapatnam Area", "Godavari Area", "Vijayawada Area", "Seema Area", "Hyderabad Area", "Other States", "e Allahabad", "SR No Sorted"];
                document.getElementById('regionHeading').innerHTML = "Members in " + regions[n] +
                    " <span class='badge'>" + tarr.length + "</span>" +
                    "<span class='badge1'>" + famPensionersCount + "</span> " +
                    "<span class='eabbadge'>" + eabcount + "</span>";

                let inThisRegion = "<table id='regionTable' border='1'><tr><td>Name / Mobile / SR No/<span class='newempid'>NewEmpId</span> / Memb No /Photo </td></tr>";
                tarr.forEach(a => {
                    inThisRegion += `<b>
                        <tr align="center" onClick="nameclick(this.id)" id="${a.id}">
                            <td class="${a.fampen.length > 0 ? "fam" : "ser"}">
                                <span class="pname">${a.name}</span>
                                ${a.fampen.length > 0 ? `<span class="smallbadge">&nbsp;</span><br>Family Pension of: ${a.fampen}` : ``}
                                ${a.ibeab === 'EAB' ? `<span class="smalleabbadge">&nbsp;</span>` : ``}
                                <br> Mobile: ${a.mobile} / SR: ${a.srno} /<span class=newempid>${a.newempid}</span> / Memb: ${a.id}  ${isPhoto(a.id)}
                            </td>
                        </tr></b>`;
                });
                inThisRegion += "</table><br><br><br>";
                document.getElementById('paraInThisRegion').innerHTML = inThisRegion;
                window.scrollTo(0, 0);
            }

let modal = document.getElementById("myModal");
            let span = document.getElementsByClassName("close")[0];

            window.onclick = function(event) {if (event.target == modal) {modal.style.display = "none";}}
            window.addEventListener('touchstart', function(event) {if (event.target == modal) {modal.style.display = "none";}});
            window.addEventListener('touchend', function(event) {if (event.target == modal) {modal.style.display = "none";}});
            function ddmmyy(input) {
                const date = new Date(input);
                return isNaN(date.getTime()) ? 'Not Available' : date.toLocaleString("en-GB", { timeZone: "Asia/Kolkata" }).substring(0, 10);
            }

            span.onclick = function() {modal.style.display = "none";}

            function nameclick(membershipNo) {
                let toDisplay = "<table border=1><tr>";
                document.getElementById("myInput").value = "";
                let membno = membershipNo * 1;
                 memphotoid = photodata.filter(a => a.id.toString() === membershipNo.toString());
                 memphoto = memphotoid.length>0 ? `<img  src='https://drive.google.com/thumbnail?id=${memphotoid[0].photoid}' height=100 width=100'>` :""
                let membData = activeMembers.filter(a => a.id === membno);
                let dob = membData[0].dob;
                let doj = membData[0].doj;
                let dor = membData[0].dor;
                let spname = membData[0].spname;
                let ptype = membData[0].fampen !== "" ? "Family Pension" : "Service Pension";
                toDisplay += `<tr><td colspan=2><b>Membership No</b> ${membData[0].id}</td></tr>`;
                toDisplay += `<tr><td colspan='2'><b>Address: </b><br>${membData[0].add1}<br>`;
                if (membData[0].add2.length > 0) toDisplay += `${membData[0].add2}<br>`;
                if (membData[0].add3.length > 0) toDisplay += `${membData[0].add3}<br>`;
                if (membData[0].place.length > 0) toDisplay += `${membData[0].place}  ${membData[0].pincode}<br>`;
                if (membData[0].district.length > 0) toDisplay += `${membData[0].district} District <br>`;
                toDisplay += `<tr><td colspan=2><b>Phones: </b>`;
                if (membData[0].fixed.length > 0) toDisplay += `${membData[0].fixed} / `;
                if (membData[0].mobile1 > 0) toDisplay += `<a href=tel:${membData[0].mobile1}><mark style='background:red;color:white'>${membData[0].mobile1}</mark></a>`;
                if (membData[0].mobile2 > 0) toDisplay += ` / ${membData[0].mobile2}`;
                toDisplay += `<tr><td colspan=2><b>Email: </b>${membData[0].email}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>S R No: </b>${membData[0].srno} /  <b>New Emp Id: </b>${membData[0].newempid}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>Application Scanned: </b>${membData[0].scanned}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>Pension Br: </b>${membData[0].pensionbr}</td></tr>`;
                if (membData[0].fampen !== "") {toDisplay += `<tr bgcolor=yellow><td colspan=2><b>Family Pension of :</b> ${membData[0].fampen}<br> DOD of Ser. Pensioner: ${membData[0].dod}</td></tr>`;}
                toDisplay += `<tr><td colspan=2><b>Pension Acc: </b> ${membData[0].sbac}</td></tr>`;
                let whichBank = membData[0].IBorEAB === 'IB' ? "Indian Bank" : "e Allahabad Bank";
                toDisplay += `<tr><td colspan=2><b>Retired from : </b> ${whichBank}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>Region : </b> ${membData[0].area.substr(0, 3)}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>DOB : </b> ${dob}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>DOJ : </b> ${doj}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>DOR : </b> ${dor}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>Spouse Name : </b> ${spname}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>Pension Type : </b> ${ptype}</td></tr>`;
                document.getElementById("modalData").innerHTML = toDisplay + "</table>";
                document.getElementById("nameHeader").innerHTML = membData[0].name;
                modal.style.display = "block";
                document.getElementById('photo').innerHTML = memphoto;

                if (isMobileDevice) {
                
                msg=`Hi ${membData[0].name}
                Message from IBRA`
                msg = encodeURIComponent(msg);
                 document.getElementById('whatsapp').innerHTML = `<a href="<http://wa.me/91${membData>[0].mobile1}?text=${msg}" target="_blank"> <img alt="Chat on WhatsApp" src="images/WhatsApp.jpg" height="50px" /></a>`;}}

function fiterName() {
                let input = document.getElementById("myInput");
                let filter = input.value.toUpperCase().replaceAll(" ", "");
                let table = document.getElementById("regionTable");
                let tr = table.getElementsByTagName("tr");
                for (let i = 0; i < tr.length; i++) {
                    let td = tr[i].getElementsByTagName("td")[0];
                    if (td) {
                        let txtValue = td.textContent || td.innerText;
                        if (txtValue.toUpperCase().replaceAll(" ", "").indexOf(filter) > -1) {
                            tr[i].style.display = "";
                        } else {
                            tr[i].style.display = "none";
                        }
                    }
                }
            }

            var btnContainer = document.getElementById("regions");
            if (btnContainer) {
                var btns = btnContainer.getElementsByClassName("list");
                for (let i = 0; i < btns.length; i++) {
                    btns[i].addEventListener("click", function () {
                        let current = document.getElementsByClassName("active");
                        if (current[0]) current[0].className = current[0].className.replace(" active", "");
                        this.className += " active";
                    });
                }
            }
         	let details = navigator.userAgent;
            let regexp = /android|iphone|kindle|ipad/i;
            let isMobileDevice = regexp.test(details);
</script>
</body>
</html>
