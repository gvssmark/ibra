
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, maximum-scale=1 , initial-scale=1.0">
  <title>IBRA-Address Book</title>
  <style>

#DataLoadedFrom {margin-top:88px; text-align:center;}
h1 { text-align: center }
        .spinner {
            border: 1px solid black;
            border-top: 1px solid orange;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 4s linear infinite;
            margin: 0 auto;
            background: red;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        body { overscroll-behavior: contain; }
        .pname {
            font-family: "Poppins", sans-serif;
            text-shadow: 3px 3px 3px #ababab;
            font-size: 25px;
        }
        a { text-decoration: none }
        body {
            background: wheat;
            font-size: small;
            margin: 0px auto;
            width: 360px;
            box-sizing: border-box;
        }
        .active, .btn:hover {
            background-color: red;
            color: white;
        }
        #regionTable td:hover {
            background-color: #9999997d;
            color: white;
        }
        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #333;
        }
        li {
            float: left;
            font-size: small;
        }
        .list {
            display: block;
            color: white;
            text-align: center;
            padding: 2px 6px;
            text-decoration: none;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-left: 1px;
            margin-right: 1px;
            border: 1px solid black;
            font-size: small;
        }
        #myInput {
            width: 300px;
            margin-left: 30px;
            height: 30px;
            border-radius: 15px;
            background-color: cyan;
            border: 0;
            outline: 0;
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            padding-top: 1px;
            left: inherit;
            top: 0;
            width: 360px;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #99ffcc;
            margin: auto;
            padding: 2px;
            padding-bottom: 2px;
            border: 1px solid #888;
            width: 95%;
            border-radius: 15px;
            margin-top: 53px;
        }
        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover, .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .badge {
            display: inline-block;
            padding: 0;
            width: 25px;
            height: 25px;
            line-height: 25px;
            font-size: x-small;
            font-weight: lighter !important;
            color: #fff !important;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            background-color: #d73d33;
            border-radius: 50px;
            top: -3px;
        }
        .badge1 {
            display: inline-block;
            padding: 0;
            width: 25px;
            height: 25px;
            line-height: 25px;
            font-size: small;
            font-weight: lighter !important;
            color: black !important;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            background-color: yellow;
            border-radius: 50px;
            top: -3px;
        }
        .eabbadge {
            display: inline-block;
            padding: 0;
            width: 25px;
            height: 25px;
            line-height: 25px;
            font-size: small;
            font-weight: lighter !important;
            color: black !important;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            background-color: pink;
            border-radius: 50px;
            top: -3px;
        }
        .smallbadge {
            display: inline-block;
            padding: 0;
            width: 10px;
            height: 10px;
            line-height: 10px;
            font-size: small;
            font-weight: lighter !important;
            color: green !important;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            background-color: yellow;
            border-radius: 50px;
            top: -3px;
        }
        .smalleabbadge {
            display: inline-block;
            padding: 0;
            width: 10px;
            height: 10px;
            line-height: 10px;
            font-size: small;
            font-weight: lighter !important;
            color: green !important;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            background-color: pink;
            border-radius: 50px;
            top: -3px;
        }
        .ibeab {
            background: pink;
        }
        button a {
            color: black;
        }
        button {
            background: yellow;
            border: 0;
            width: 170px;
            padding: 5px;
            border-radius: 15px;
            box-shadow: 3px 5px #888888;
            margin-left: 5px;
        }
        img {
            border-radius: 50px;
        }
        #whatsapp {
            margin-top: -100px;
            float: right;
        }
        #page1 {
            display: none;
        }





  </style>
</head>
<body>
  
  
 <!-- <p id='Addressbookdata'>Number of Records</p>
  <p id='Photodata'>Number of Records</p> 
  <p id='DataLastUpdatedOn'>Data Last Updated on</p>-->

<div id="regions" style="display:block;">
  <div style="background:powderblue; top:0; height:83px; overflow:auto; position:fixed; width: 360px;">
            <ul>
                <li onclick="selectedRegion('allmemb',0)" class="list active">All</li>
                <li onclick="selectedRegion('VSP',1)" class="list">VSP</li>
                <li onclick="selectedRegion('GOD',2)" class="list">GOD</li>
                <li onclick="selectedRegion('VIJ',3)" class="list">VIJ</li>
                <li onclick="selectedRegion('SEE',4)" class="list">SEEMA</li>
                <li onclick="selectedRegion('HYD',5)" class="list">HYD</li>
                <li onclick="selectedRegion('OTH',6)" class="list">OTH</li>
                <li onclick="selectedRegion('EAB',7)" class="list">eAB</li>
                <li onclick="selectedRegion('allMembNoWise',8)" class="list">SR No</li>
            </ul>
            
            <h4 id='regionHeading' align="center" style="margin-top: 0; margin-bottom: 0;"></h4>
            <input type="text" id='myInput' placeholder="Search here..." onkeyup="fiterName()">
        </div>
        
      <p id='DataLoadedFrom'>Loading...</p>  
 <p id='paraInThisRegion' ></p>
 
 <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h4 align="center" id="nameHeader"></h4>
                <p id="modalData"></p>
                <div id='photo' style='margin-top:-266px; float:right'></div>
                <div id='whatsapp'></div>
            </div>
        </div>
<script>
//==== Utility: Date Formatting ====
function formatDate(input) {
  const date = new Date(input);
  return isNaN(date) ? 'Not Available' : date.toLocaleString('en-GB');
}

//==== Fetch Data Functions ====
async function fetchJson(url) {
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`Fetch failed: ${url}`);
  return await res.json();
}
async function fetchLatestTimestamp() {
  const url = 'https://script.google.com/macros/s/AKfycbwo-TtPn3DAjHSPCXDwPFerT36QyfPPvUTi7uQEvcmjJso_aWpaKefUsgx_vpJOowHUgg/exec?sheetid=1MaB1PMP3ouY3Es5ziLgY7dhT3ZSb6oHRgecw3JiJfGw&sheetname=Sheet1';
  const res = await fetch(url, { cache: 'no-store' });
  const text = (await res.text()).trim();
  // Handle [[timestamp]] case
  try {
    const parsed = JSON.parse(text);
    return Array.isArray(parsed) ? parsed.flat(Infinity)[0] : parsed;
  } catch {
    return text;
  }
}
async function cacheData(key, data) {
  const cache = await caches.open('addbook');
  const response = new Response(JSON.stringify(data), { headers: { 'Content-Type': 'application/json' } });
  await cache.put(key, response);
}
async function readCachedData(key) {
  const cache = await caches.open('addbook');
  const response = await cache.match(key);
  if (!response || !response.ok) return null;
  try {
    return await response.json();
  } catch {
    return null;
  }
}
async function fetchAddBookData() {
  const url = 'https://script.google.com/macros/s/AKfycbwIVAlRrCTt6z_Ej4W6PHhopFqCq1JvEsSoN2RPqgWY7VXLW0P2pteA1jgVFaWePc2S/exec';
  let data = await fetchJson(url);
  data.shift(); // remove header
  const formatted = data.map(([id, name, add1, add2, add3, district, place, pincode, fixed, mobile1, mobile2, state, email, srno, sbac, doj, dor, spname, area, blank1, dob, fampen, pensionbr, scanned, newempid, dod, blank2, blank3, blank4]) => ({
    id, name, add1, add2, add3, district, place, pincode, fixed, mobile1, mobile2, state, email, srno, sbac,
    doj: formatDate(doj), dor: formatDate(dor), spname, area, blank1, dob: formatDate(dob), fampen, pensionbr, scanned, newempid, dod: formatDate(dod),
    blank2, blank3, blank4
  }));
  await cacheData('/custom/addbookdata.json', formatted);
  return formatted;
}
async function fetchPhotoData() {
  const url = 'https://script.google.com/macros/s/AKfycbw_h5LMGCyIraesAhh6xlkeP8RUz3HO4ga4Q8XZaJhJRpnuQqp3TWUUZyodZPxpeA7A/exec';
  let data = await fetchJson(url);
  data.shift();
  const photos = data.map(([id, photoid]) => ({ id, photoid }));
  await cacheData('/custom/addbookphotodata.json', photos);
  return photos;
}

//==== Report Renderer ====
function showReport(addBookData, photoData, source, serverTimestamp) {
  document.getElementById("DataLoadedFrom").textContent =
    `Report from: ${source} - ${formatDate(serverTimestamp-(5.5*60*60*1000))}`;
  //document.getElementById("Addressbookdata").textContent =
    "Addressbook Records: " + (addBookData ? addBookData.length : 0);
  //document.getElementById("Photodata").textContent =
    "Photo Records: " + (photoData ? photoData.length : 0);
  //document.getElementById("DataLastUpdatedOn").textContent =
    "Data Last Updated on: " + formatDate(serverTimestamp-(5.5*60*60*1000));
    data = addBookData
    photodata = photoData
    isPhoto = (id) => photodata.some(a => a.id.toString() === id.toString()) ? '<span>👨</span>' : '';
    processData()
    console.log(activeMembers)
    console.log(photodata)
    selectedRegion('allmemb', 0);
}

//==== Init with Cache-then-Network Strategy ====
async function initReport() {
  // 1. Try cache first (instant report)
  let [addBookData, photoData] = await Promise.all([
    readCachedData('/custom/addbookdata.json'),
    readCachedData('/custom/addbookphotodata.json')
  ]);

  const localTimestamp = localStorage.getItem("data_updated_at");

  if (addBookData && photoData && localTimestamp) {
    showReport(addBookData, photoData, "Cache", localTimestamp);
  } else {
    document.getElementById("DataLoadedFrom").textContent = "No cache, waiting for server...";
  }

  // 2. In background, check server timestamp
  try {
    const serverTimestamp = await fetchLatestTimestamp();
    const localTimestamp = localStorage.getItem("data_updated_at");

    if (!addBookData || !photoData || localTimestamp != serverTimestamp) {
      // Fetch fresh if missing or outdated
      [addBookData, photoData] = await Promise.all([
        fetchAddBookData(),
        fetchPhotoData()
      ]);
      localStorage.setItem("data_updated_at", serverTimestamp);
      showReport(addBookData, photoData, "Server (updated)", serverTimestamp);
    }
  } catch (err) {
    console.error("Background refresh failed", err);
  }
}

initReport();

function processData() {
  activeMembers = data.filter(a => a.name !== "").sort((a, b) => a.name.localeCompare(b.name));
  activeMembers.forEach(element => {
    element.IBorEAB = (element.area.substr(-3).toUpperCase() === 'EAB' ? "EAB" : "IB");
    element.pentype = (element.fampen.length > 0 ? "fam" : "ser");
  });
  familyPensioners = activeMembers.filter(a => a.fampen !== "")
    .map(a => ({ id: a.id, name: a.name, fampen: a.fampen, ibeab: a.IBorEAB }));
  blank = activeMembers.filter(a => a.area === "BLANK")
    .map(a => ({ id: a.id, name: a.name, fampen: a.fampen, ibeab: a.IBorEAB, srno: a.srno, mobile: a.mobile1 }));
  allMembNoWise = activeMembers.map(a => ({
    id: a.id, name: a.name, fampen: a.fampen, ibeab: a.IBorEAB,
    srno: a.srno, mobile: a.mobile1, newempid: a.newempid
  })).sort((a, b) => a.srno - b.srno);
  allmemb = activeMembers.map(a => ({
    id: a.id, name: a.name, fampen: a.fampen, ibeab: a.IBorEAB,
    srno: a.srno, mobile: a.mobile1, newempid: a.newempid
  }));
   
}

function selectedRegion(array, n) {
                let tany = activeMembers.filter(a => a.area.includes(array)).map(a => ({
                    id: a.id, name: a.name, fampen: a.fampen, ibeab: a.IBorEAB,
                    srno: a.srno, mobile: a.mobile1, newempid: a.newempid
                }));
                let tarr = array === 'allmemb' ? allmemb : array === 'allMembNoWise' ? allMembNoWise : tany;
                document.getElementById("myInput").value = "";
                document.getElementById("myInput").style.display = "block";
                document.documentElement.scrollTop = 0;

                let famPensionersCount = tarr.filter(a => a.fampen.length > 0).length;
                let eabcount = tarr.filter(a => a.ibeab === 'EAB').length;
                let regions = ["All Members", "Visakhapatnam Area", "Godavari Area", "Vijayawada Area", "Seema Area", "Hyderabad Area", "Other States", "e Allahabad", "SR No Sorted"];
                document.getElementById('regionHeading').innerHTML = "Members in " + regions[n] +
                    " <span class='badge'>" + tarr.length + "</span>" +
                    "<span class='badge1'>" + famPensionersCount + "</span> " +
                    "<span class='eabbadge'>" + eabcount + "</span>";

                let inThisRegion = "<table id='regionTable' border='1'><tr><td>Name / Mobile / SR No/<span class='newempid'>NewEmpId</span> / Memb No /Photo </td></tr>";
                tarr.forEach(a => {
                    inThisRegion += `<b>
                        <tr align="center" onClick="nameclick(this.id)" id="${a.id}">
                            <td class="${a.fampen.length > 0 ? "fam" : "ser"}">
                                <span class="pname">${a.name}</span>
                                ${a.fampen.length > 0 ? `<span class="smallbadge">&nbsp;</span><br>Family Pension of: ${a.fampen}` : ``}
                                ${a.ibeab === 'EAB' ? `<span class="smalleabbadge">&nbsp;</span>` : ``}
                                <br> Mobile: ${a.mobile} / SR: ${a.srno} /<span class=newempid>${a.newempid}</span> / Memb: ${a.id}  ${isPhoto(a.id)}
                            </td>
                        </tr></b>`;
                });
                inThisRegion += "</table><br><br><br>";
                document.getElementById('paraInThisRegion').innerHTML = inThisRegion;
                window.scrollTo(0, 0);
            }

let modal = document.getElementById("myModal");
            let span = document.getElementsByClassName("close")[0];

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
            window.addEventListener('touchstart', function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            });
            window.addEventListener('touchend', function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            });

            function ddmmyy(input) {
                const date = new Date(input);
                return isNaN(date.getTime()) ? 'Not Available' : date.toLocaleString("en-GB", { timeZone: "Asia/Kolkata" }).substring(0, 10);
            }

            span.onclick = function() {
                modal.style.display = "none";
            }

            function nameclick(membershipNo) {
                let toDisplay = "<table border=1><tr>";
                document.getElementById("myInput").value = "";

                let membno = membershipNo * 1;
                 memphotoid = photodata.filter(a => a.id.toString() === membershipNo.toString());
                //console.log(memphotoid)
                 memphoto = memphotoid.length>0 ? `<img  src='https://drive.google.com/thumbnail?id=${memphotoid[0].photoid}' height=100 width=100'>`  : ""

                let membData = activeMembers.filter(a => a.id === membno);

                let dob = membData[0].dob;
                let doj = membData[0].doj;
                let dor = membData[0].dor;
                let spname = membData[0].spname;
                let ptype = membData[0].fampen !== "" ? "Family Pension" : "Service Pension";

                toDisplay += `<tr><td colspan=2><b>Membership No</b> ${membData[0].id}</td></tr>`;
                toDisplay += `<tr><td colspan='2'><b>Address: </b><br>${membData[0].add1}<br>`;
                if (membData[0].add2.length > 0) toDisplay += `${membData[0].add2}<br>`;
                if (membData[0].add3.length > 0) toDisplay += `${membData[0].add3}<br>`;
                if (membData[0].place.length > 0) toDisplay += `${membData[0].place}  ${membData[0].pincode}<br>`;
                if (membData[0].district.length > 0) toDisplay += `${membData[0].district} District <br>`;
                toDisplay += `<tr><td colspan=2><b>Phones: </b>`;
                if (membData[0].fixed.length > 0) toDisplay += `${membData[0].fixed} / `;
                if (membData[0].mobile1 > 0) toDisplay += `<a href=tel:${membData[0].mobile1}><mark style='background:red; color:white'>${membData[0].mobile1}</mark></a>`;
                if (membData[0].mobile2 > 0) toDisplay += ` / ${membData[0].mobile2}`;
                toDisplay += `<tr><td colspan=2><b>Email: </b>${membData[0].email}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>S R No: </b>${membData[0].srno} /  <b>New Emp Id: </b>${membData[0].newempid}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>Application Scanned: </b>${membData[0].scanned}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>Pension Br: </b>${membData[0].pensionbr}</td></tr>`;

                if (membData[0].fampen !== "") {
                    toDisplay += `<tr bgcolor=yellow><td colspan=2><b>Family Pension of :</b> ${membData[0].fampen}<br> DOD of Ser. Pensioner: ${membData[0].dod}</td></tr>`;
                }

                toDisplay += `<tr><td colspan=2><b>Pension Acc: </b> ${membData[0].sbac}</td></tr>`;
                let whichBank = membData[0].IBorEAB === 'IB' ? "Indian Bank" : "e Allahabad Bank";
                toDisplay += `<tr><td colspan=2><b>Retired from : </b> ${whichBank}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>Region : </b> ${membData[0].area.substr(0, 3)}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>DOB : </b> ${dob}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>DOJ : </b> ${doj}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>DOR : </b> ${dor}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>Spouse Name : </b> ${spname}</td></tr>`;
                toDisplay += `<tr><td colspan=2><b>Pension Type : </b> ${ptype}</td></tr>`;

                document.getElementById("modalData").innerHTML = toDisplay + "</table>";
                document.getElementById("nameHeader").innerHTML = membData[0].name;
                modal.style.display = "block";
                document.getElementById('photo').innerHTML = memphoto;

                if (isMobileDevice) {
                   msg=`Hi ${membData[0].name}
                Message from IBRA`
                msg = encodeURIComponent(msg);
                 document.getElementById('whatsapp').innerHTML = `<a href="<http://wa.me/91${membData>[0].mobile1}?text=${msg}" target="_blank"> <img alt="Chat on WhatsApp" src="images/WhatsApp.jpg" height="50px" /></a>`;
                  //  document.getElementById('whatsapp').innerHTML = `<a aria-label="Chat on WhatsApp" href="<https://wa.me/91${membData>[0].mobile1}"> <img alt="Chat on WhatsApp" src="images/WhatsApp.jpg" height="50px" /></a>`;
                }
            }

function fiterName() {
                let input = document.getElementById("myInput");
                let filter = input.value.toUpperCase().replaceAll(" ", "");
                let table = document.getElementById("regionTable");
                let tr = table.getElementsByTagName("tr");
                for (let i = 0; i < tr.length; i++) {
                    let td = tr[i].getElementsByTagName("td")[0];
                    if (td) {
                        let txtValue = td.textContent || td.innerText;
                        if (txtValue.toUpperCase().replaceAll(" ", "").indexOf(filter) > -1) {
                            tr[i].style.display = "";
                        } else {
                            tr[i].style.display = "none";
                        }
                    }
                }
            }

            var btnContainer = document.getElementById("regions");
            if (btnContainer) {
                var btns = btnContainer.getElementsByClassName("list");
                for (let i = 0; i < btns.length; i++) {
                    btns[i].addEventListener("click", function () {
                        let current = document.getElementsByClassName("active");
                        if (current[0]) current[0].className = current[0].className.replace(" active", "");
                        this.className += " active";
                    });
                }
            }

         let details = navigator.userAgent;
            let regexp = /android|iphone|kindle|ipad/i;
            let isMobileDevice = regexp.test(details);


</script>
</body>
</html>
