<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>IBRA Attendance Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      max-width: 400px;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, button {
      width: 95%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    p {
      color: red;
      font-size: 14px;
    }
    /* Loader styles */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
      display: none; /* Hidden by default */
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loader-container {
      text-align: center;
      margin-top: 20px;
    }

    #srNo {font-size: 1.5em;}
  </style>
</head>
<body>
<form name="submit-to-google-sheet" id="attend25">
  <h2>IBRA Attendance Form</h2>
  <div class="loader-container">
    <div class="loader" id="loader"></div>
  </div>
  <label for="srNo">SR No:</label>
  <input type="number" id="srNo" placeholder="Enter SR No" name="SRNo" pattern="\d*" required />
  <label for="membershipNo">Membership Number:</label>
  <input type="text" id="membershipNo" name="Membership No" readonly />
  <label for="name">Name:</label>
  <input type="text" id="name" name="Name" readonly />
  <label for="attendanceDate">Attendance (Date-Time):</label>
  <input type="text" id="attendanceDate" name="Attendance" readonly />
  <button id="okButton" disabled>OK</button>
  <button type="button" onclick="resetForm()">Cancel</button>
  <p id="message"></p>
</form>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbytzFhmFLKbTpwiMhtvPUGyi26GTFg2i9cIPkbLQKrEfRd4Mb-ezKptfrf7nm-fSzUM/exec';
  const dataFetchURL = 'https://script.google.com/macros/s/AKfycbxhKiIJzTPokink9zUovt3N8qrhGnOUD8Eu9V34QWGKxxbqm6xE_ucZzv-Od1rAyZXP/exec';

  const form = document.forms['submit-to-google-sheet'];
  const loader = document.getElementById('loader');
  const srNoInput = document.getElementById('srNo');
  const membershipNoInput = document.getElementById('membershipNo');
  const nameInput = document.getElementById('name');
  const attendanceDateInput = document.getElementById('attendanceDate');
  const okButton = document.getElementById('okButton');
  const messageElement = document.getElementById('message');

  let memberData = [];
  let attendanceData = [];

  // Fetch data from Google Sheets
  async function fetchData() {
    try {
      toggleFormAccessibility(false);
      showLoader(true);
      const response = await fetch(dataFetchURL);
      const data = await response.json();
      memberData = data['Data-data'].slice(1); // Remove headers
      attendanceData = data['Attendance-data'].slice(1); // Remove headers
    } catch (error) {
      console.error('Error fetching data:', error);
      messageElement.textContent = 'Error fetching data. Please try again later.';
    } finally {
      showLoader(false);
      toggleFormAccessibility(true);
    }
  }

  // Show or hide loader
  function showLoader(visible) {
    loader.style.display = visible ? 'block' : 'none';
  }

  // Enable or disable form inputs and buttons
  function toggleFormAccessibility(enable) {
    const formElements = form.querySelectorAll('input, button');
    formElements.forEach(element => element.disabled = !enable);
  }

  // Rest of the code...
  srNoInput.addEventListener('blur', () => {
    const srNo = parseInt(srNoInput.value, 10);
    if (isNaN(srNo)) {
      displayMessage('Please enter a valid SR No.');
      return;
    }

    const member = memberData.find(row => row[0] === srNo);
    const alreadyMarked = attendanceData.some(row => row[0] === srNo);

    if (!member) {
      displayMessage('You are not a member.');
      resetInputs();
    } else if (alreadyMarked) {
      displayMessage('Attendance already marked.');
      resetInputs();
    } else {
      membershipNoInput.value = member[2];
      nameInput.value = member[1];
      attendanceDateInput.value = new Date().toLocaleString();
      okButton.disabled = false;
      displayMessage('');
    }
  });

  form.addEventListener('submit', async e => {
    e.preventDefault();

    const formData = new FormData(form);
    formData.append('spreadsheetId', '1t9eFaGHPBvsqpzWFnEFI_NlMRdnWVqti1TwW3kraCvQ');
    formData.append('sheetName', 'Attendance');
    formData.append('Membership No', membershipNoInput.value);

    try {
      toggleFormAccessibility(false);
      showLoader(true);
      const response = await fetch(scriptURL, { method: 'POST', body: formData });
      const result = await response.json();
      displayMessage('Attendance marked successfully!', 'green');
      form.reset();
      resetInputs();
      await fetchData(); // Refresh data
    } catch (error) {
      console.error('Error:', error);
      displayMessage('Error marking attendance. Please try again.');
    } finally {
      showLoader(false);
      toggleFormAccessibility(true);
    }
  });

  function resetForm() {
    form.reset();
    resetInputs();
    displayMessage('');
  }

  function resetInputs() {
    membershipNoInput.value = '';
    nameInput.value = '';
    attendanceDateInput.value = '';
    okButton.disabled = true;
  }

  function displayMessage(message, color = 'red') {
    messageElement.textContent = message;
    messageElement.style.color = color;
  }

  // Fetch data on page load
  fetchData();
</script>
</body>
</html>
